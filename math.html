<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Draw & Count</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&display=swap');
        body {
            font-family: 'Fredoka', sans-serif;
            background: linear-gradient(135deg, #fff2cc, #ffc0cb);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            overflow-y: auto; 
            position: relative; 
        }
        .app-container {
            background-color: #ffffff;
            border-radius: 25px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
            max-width: 700px;
            width: 100%;
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            text-align: center;
        }
        .header h1 {
            font-size: 2.5rem;
            color: #d85768;
            text-shadow: 2px 2px #ffc0cb;
        }
        .math-problem {
            font-size: 3rem;
            font-weight: bold;
            color: #4b3d8f;
        }
        .drawing-pad {
            background-color: #f7f9fc;
            border: 3px solid #d85768;
            border-radius: 15px;
            padding: 20px;
            min-height: 200px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 15px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
        }
        /* New cursor style for counting mode */
        .drawing-pad.counting-mode {
            cursor: pointer;
        }
        .ball {
            width: 50px;
            height: 50px;
            background-color: #ffd166;
            border-radius: 50%;
            border: 2px solid #ff9d00;
            transition: transform 0.2s ease-in-out, background-color 0.3s;
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
            position: relative;
        }
        .ball:hover {
            transform: scale(1.1);
        }
        /* Style for counted balls */
        .ball.counted {
            background-color: #a8d0e6;
            border-color: #4d87ac;
        }
        /* Strikethrough for subtraction */
        .ball.strikethrough::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 120%;
            height: 4px;
            background-color: #d84351;
            transform: translate(-50%, -50%) rotate(45deg);
        }
        .buttons-group {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        .action-btn {
            background-color: #8ac926;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 5px #6aa11e;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .action-btn:active {
            transform: translateY(2px);
            box-shadow: 0 3px #6aa11e;
        }
        .check-btn {
            background-color: #4b3d8f;
            box-shadow: 0 5px #3a2d6f;
        }
        .check-btn:active {
            box-shadow: 0 3px #3a2d6f;
        }
        .reset-btn {
            background-color: #ff5e6c;
            box-shadow: 0 5px #d84351;
        }
        .reset-btn:active {
            transform: translateY(2px);
            box-shadow: 0 3px #d84351;
        }
        .message-box {
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 10px;
        }
        .correct {
            color: #2a9d8f;
        }
        .incorrect {
            color: #e76f51;
        }
        .answer-input-group {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }
        .answer-input-group input {
            padding: 10px;
            border-radius: 10px;
            border: 2px solid #a8d0e6;
            text-align: center;
            font-size: 1.2rem;
            width: 80px;
        }
        .operator-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        .operator-btn {
            background-color: #4b3d8f;
            color: white;
            padding: 15px 30px;
            border-radius: 15px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 5px #3a2d6f;
        }
        .operator-btn:active {
            transform: translateY(2px);
            box-shadow: 0 3px #3a2d6f;
        }
        .voice-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #4b3d8f;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 3px #3a2d6f;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .voice-toggle:active {
            transform: translateY(1px);
            box-shadow: 0 2px #3a2d6f;
        }

        /* Styles for the new balloon elements and animation */
        .balloon {
            position: absolute;
            /* CHANGE: Balloons now start at the top */
            top: -150px;
            width: 40px;
            height: 50px;
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            transform-origin: 50% 100%;
            opacity: 0.8;
            /* New animation for swaying and floating */
            animation: floatUp 5s ease-in-out forwards, sway 2s ease-in-out infinite alternate;
        }
        /* New balloon colors */
        .balloon:nth-child(3n+1) { background-color: #ff6b6b; }
        .balloon:nth-child(3n+2) { background-color: #ffd166; }
        .balloon:nth-child(3n+3) { background-color: #06d6a0; }
        
        /* Add a string to the balloon using a pseudo-element */
        .balloon::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50%;
            width: 2px;
            height: 20px;
            background-color: rgba(0, 0, 0, 0.2);
            transform: translateX(-50%);
        }

        @keyframes floatUp {
            0% {
                transform: translateY(0);
                opacity: 0.8;
            }
            100% {
                transform: translateY(-120vh);
                opacity: 0;
            }
        }
        /* New swaying animation */
        @keyframes sway {
            from {
                transform: rotate(-5deg);
            }
            to {
                transform: rotate(5deg);
            }
        }
    </style>
</head>
<body>

    <!-- Audio elements for correct and incorrect sounds -->
    <audio id="incorrectSound" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" preload="auto"></audio>

    <div class="app-container">
        <!-- Voice Toggle Button -->
        <button id="voiceToggle" class="voice-toggle">Voice: On</button>

        <!-- Header Section -->
        <div class="header">
            <h1>Let's Count!</h1>
            <p>Choose an operation to begin.</p>
        </div>

        <!-- Operator Selection Buttons -->
        <div class="operator-buttons">
            <button id="additionBtn" class="operator-btn">+</button>
            <button id="subtractionBtn" class="operator-btn">-</button>
        </div>

        <!-- The Math Problem with dynamic operator -->
        <div class="math-problem">
            <span id="num1Display">?</span> <span id="operatorDisplay">?</span> <span id="num2Display">?</span> = ?
        </div>

        <!-- The "Drawing" Area -->
        <div id="drawingPad" class="drawing-pad">
            <!-- Balls will be added here -->
        </div>

        <!-- Action Buttons -->
        <div class="buttons-group">
            <button id="addBalls1" class="action-btn">Add Balls</button>
            <button id="addBalls2" class="action-btn">Add More Balls</button>
            <!-- New buttons for subtraction and counting all balls -->
            <button id="takeAwayBallBtn" class="action-btn reset-btn" style="display: none;">Take Away Ball</button>
            <button id="countAllBtn" class="action-btn check-btn" style="display: none;">Count All</button>
        </div>
        
        <!-- Input field for the answer -->
        <div class="answer-input-group">
            <input type="number" id="userAnswer" placeholder="Count and Type Here" />
            <button id="checkAnswer" class="action-btn check-btn">Check</button>
            <button id="resetBtn" class="action-btn reset-btn">Reset</button>
        </div>

        <!-- Feedback and Final Answer -->
        <div id="feedback" class="message-box"></div>
    </div>

    <script>
        // Get references to all the elements
        const num1Display = document.getElementById('num1Display');
        const num2Display = document.getElementById('num2Display');
        const operatorDisplay = document.getElementById('operatorDisplay'); 
        const drawingPad = document.getElementById('drawingPad');
        const addBalls1Btn = document.getElementById('addBalls1');
        const addBalls2Btn = document.getElementById('addBalls2');
        const userAnswerInput = document.getElementById('userAnswer');
        const checkAnswerBtn = document.getElementById('checkAnswer');
        const resetBtn = document.getElementById('resetBtn');
        const feedbackBox = document.getElementById('feedback');
        const additionBtn = document.getElementById('additionBtn');
        const subtractionBtn = document.getElementById('subtractionBtn');
        const takeAwayBallBtn = document.getElementById('takeAwayBallBtn');
        const countAllBtn = document.getElementById('countAllBtn');
        const voiceToggleBtn = document.getElementById('voiceToggle');

        // Audio elements
        const incorrectSound = document.getElementById('incorrectSound');
        
        // Problem variables
        let num1, num2, operator;
        let ballsAdded1 = 0;
        let ballsAdded2 = 0;
        let ballsRemoved = 0; // New variable to track removed balls for counting up
        let voiceEnabled = true;
        let kidVoice = null; // Variable to store the selected kid-friendly voice
        
        // New variables for interactive counting mode
        let countingMode = false;
        let currentCountIndex = 0;

        // This event fires when the list of available voices changes.
        // It's the best way to get voices and set them up.
        window.speechSynthesis.onvoiceschanged = () => {
            const voices = window.speechSynthesis.getVoices();
            // Try to find a kid-friendly voice.
            // A good heuristic is to look for a voice from Google, or one that sounds less generic.
            kidVoice = voices.find(voice => voice.name.includes('Google') || voice.name.includes('Samantha') || voice.name.includes('Zira') || voice.name.includes('Leda')) || voices[0];
        };

        // Function to speak text using the Web Speech API with a faster rate
        function speakText(text) {
            if ('speechSynthesis' in window && voiceEnabled) {
                // IMPORTANT: Immediately cancel any previous speech to make the voice feel responsive.
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 1.5; // Set the voice rate to be faster
                // Use the selected kid-friendly voice if available
                if (kidVoice) {
                    utterance.voice = kidVoice;
                }
                window.speechSynthesis.speak(utterance);
            }
        }
        
        // Function to update the feedback box text (now silent)
        function updateFeedback(text, isCorrect = false) {
            feedbackBox.textContent = text;
            feedbackBox.className = 'message-box ' + (isCorrect ? 'correct' : 'incorrect');
        }

        // Function to create balloon celebration effect
        function createBalloons() {
            const balloonColors = ['#ff6b6b', '#ffd166', '#06d6a0', '#118ab2', '#ef476f'];
            const numBalloons = 20;
            const container = document.body;

            for (let i = 0; i < numBalloons; i++) {
                const balloon = document.createElement('div');
                balloon.className = 'balloon';
                // Use a random color from the defined array
                const randomColor = balloonColors[Math.floor(Math.random() * balloonColors.length)];
                balloon.style.backgroundColor = randomColor;
                balloon.style.left = `${Math.random() * 100}vw`;

                // Add a small delay for a staggered effect
                balloon.style.animationDelay = `${Math.random() * 0.5}s`;

                container.appendChild(balloon);

                // Remove balloon after animation
                balloon.addEventListener('animationend', () => {
                    balloon.remove();
                });
            }
        }

        // Event listener for the voice toggle button
        voiceToggleBtn.addEventListener('click', () => {
            voiceEnabled = !voiceEnabled;
            if (voiceEnabled) {
                voiceToggleBtn.textContent = 'Voice: On';
                speakText("Voice enabled.");
            } else {
                voiceToggleBtn.textContent = 'Voice: Off';
                window.speechSynthesis.cancel();
            }
        });

        /**
         * Initializes or resets the app with a new problem based on the selected operator.
         * @param {string} op The selected operator ('+' or '-').
         */
        function initializeNewProblem(op) {
            operator = op;

            // Generate random numbers between 1 and 9
            num1 = Math.floor(Math.random() * 9) + 1;
            num2 = Math.floor(Math.random() * 9) + 1;

            // New logic to ensure subtraction problems do not result in zero or a negative number.
            if (operator === '-') {
                // Keep generating numbers until num1 is greater than num2.
                // This prevents problems like 7-7 or 3-5.
                do {
                    num1 = Math.floor(Math.random() * 9) + 1;
                    num2 = Math.floor(Math.random() * 9) + 1;
                } while (num1 <= num2);
            }
            
            // Reset visual elements and counters
            ballsAdded1 = 0;
            ballsAdded2 = 0;
            ballsRemoved = 0; // Reset the new counter
            drawingPad.innerHTML = '';
            userAnswerInput.value = '';
            
            // Reset interactive counting mode
            countingMode = false;
            currentCountIndex = 0;
            drawingPad.classList.remove('counting-mode');
            addBalls1Btn.disabled = false;
            addBalls2Btn.disabled = false;
            takeAwayBallBtn.disabled = false;
            checkAnswerBtn.disabled = false;
            
            // Update the display with the new numbers and operator
            num1Display.textContent = num1;
            operatorDisplay.textContent = operator;
            num2Display.textContent = num2;

            // Update button text to match the new problem
            addBalls1Btn.textContent = `Add ${num1} Balls`;
            addBalls2Btn.textContent = `Add ${num2} More Balls`;
            
            // Show/hide buttons based on the operator
            if (operator === '-') {
                addBalls2Btn.style.display = 'none';
                takeAwayBallBtn.style.display = 'inline-block';
                countAllBtn.style.display = 'inline-block';
                updateFeedback(`First, add ${num1} balls, then use the "Take Away Ball" button to subtract.`, false);
            } else {
                addBalls2Btn.style.display = 'inline-block';
                takeAwayBallBtn.style.display = 'none';
                countAllBtn.style.display = 'inline-block';
                updateFeedback("Click on 'Add Balls' to begin.", false);
            }
        }

        /**
         * Function to create and add a single ball element
         */
        function addBall() {
            const ball = document.createElement('div');
            ball.className = 'ball';
            drawingPad.appendChild(ball);
        }

        // Event listener for the addition button
        additionBtn.addEventListener('click', () => initializeNewProblem('+'));

        // Event listener for the subtraction button
        subtractionBtn.addEventListener('click', () => initializeNewProblem('-'));
        
        // Event listener for the "Add Balls" button
        addBalls1Btn.addEventListener('click', () => {
            if (operator === '+') {
                if (ballsAdded1 < num1) {
                    addBall();
                    ballsAdded1++;
                    speakText(ballsAdded1);
                } else {
                    updateFeedback("You've added all the balls for the first number!", false);
                }
            } else { // Subtraction
                if (drawingPad.children.length < num1) {
                    addBall();
                    ballsAdded1++; // Increment counter for subtraction setup
                    speakText(ballsAdded1); // Speak the current count
                } else {
                    updateFeedback("You have all the balls. Now subtract!", false);
                }
            }
        });

        // Event listener for the second "Add Balls" button (for addition)
        addBalls2Btn.addEventListener('click', () => {
            if (ballsAdded1 === num1 && ballsAdded2 < num2) {
                addBall();
                ballsAdded2++;
                speakText(ballsAdded2);
            } else if (ballsAdded1 < num1) {
                updateFeedback("Finish adding the first set of balls first!", false);
            } else {
                updateFeedback("You've added all the balls for the second number!", false);
            }
        });
        
        // Event listener for the "Take Away Ball" button (for subtraction)
        takeAwayBallBtn.addEventListener('click', () => {
            const balls = drawingPad.querySelectorAll('.ball:not(.strikethrough)');
            if (balls.length > num1 - num2) {
                const lastBall = balls[balls.length - 1];
                lastBall.classList.add('strikethrough');
                // Speak the count of balls removed so far
                ballsRemoved++;
                speakText(ballsRemoved);
            } else {
                updateFeedback(`You've taken away all ${num2} balls!`, false);
            }
        });

        // Event listener for the "Count All" button
        countAllBtn.addEventListener('click', () => {
            const balls = drawingPad.querySelectorAll('.ball:not(.strikethrough)');
            if (balls.length > 0) {
                countingMode = true;
                currentCountIndex = 0;
                updateFeedback('Tap on the balls to count them one by one!', false);
                speakText('Tap on the balls to count them one by one!');
                drawingPad.classList.add('counting-mode');
                // Disable other buttons to avoid user confusion while counting
                addBalls1Btn.disabled = true;
                addBalls2Btn.disabled = true;
                takeAwayBallBtn.disabled = true;
                checkAnswerBtn.disabled = true;
            } else {
                updateFeedback('There are no balls to count.', false);
            }
        });

        // Event listener for clicks inside the drawing pad
        drawingPad.addEventListener('click', (event) => {
            if (!countingMode) {
                return;
            }

            const clickedBall = event.target;
            if (clickedBall.classList.contains('ball') && !clickedBall.classList.contains('strikethrough') && !clickedBall.classList.contains('counted')) {
                currentCountIndex++;
                speakText(currentCountIndex);
                clickedBall.classList.add('counted');
                updateFeedback(`Counting: ${currentCountIndex}`, false);

                const ballsToCount = drawingPad.querySelectorAll('.ball:not(.strikethrough)');
                if (currentCountIndex === ballsToCount.length) {
                    countingMode = false;
                    updateFeedback(`The total number of balls is...`, false);
                    speakText(`The total number of balls is...`);
                    drawingPad.classList.remove('counting-mode');
                    addBalls1Btn.disabled = false;
                    addBalls2Btn.disabled = false;
                    takeAwayBallBtn.disabled = false;
                    checkAnswerBtn.disabled = false;
                }
            }
        });

        // Event listener for the "Check Answer" button
        checkAnswerBtn.addEventListener('click', () => {
            const userAnswer = parseInt(userAnswerInput.value, 10);
            let correctAnswer;
            let currentBalls;

            // Calculate based on the operator
            if (operator === '+') {
                correctAnswer = num1 + num2;
            } else { // Subtraction
                correctAnswer = num1 - num2;
                currentBalls = drawingPad.querySelectorAll('.ball:not(.strikethrough)').length;
            }

            if (isNaN(userAnswer)) {
                updateFeedback("Please type a number in the box.", false);
            } else if (userAnswer === correctAnswer) {
                updateFeedback(`Correct! ${num1} ${operator} ${num2} = ${correctAnswer} 🎉`, true);
                createBalloons(); // Call the balloon celebration function
            } else if (operator === '-' && userAnswer === currentBalls) {
                updateFeedback(`You've counted the balls on the screen correctly! Now, take away the rest of the balls.`, false);
                incorrectSound.currentTime = 0;
                incorrectSound.play();
                setTimeout(() => {
                    incorrectSound.pause();
                    incorrectSound.currentTime = 0;
                }, 6000); // Stop playing after 6 seconds
            } else {
                updateFeedback(`Oops! That's not right. Try counting the balls again.`, false);
                incorrectSound.currentTime = 0;
                incorrectSound.play();
                setTimeout(() => {
                    incorrectSound.pause();
                    incorrectSound.currentTime = 0;
                }, 6000); // Stop playing after 6 seconds
            }
        });

        // Event listener for the "Reset" button
        resetBtn.addEventListener('click', () => {
            // Reset to the initial state
            num1Display.textContent = '?';
            operatorDisplay.textContent = '?';
            num2Display.textContent = '?';
            drawingPad.innerHTML = '';
            ballsAdded1 = 0;
            ballsAdded2 = 0;
            userAnswerInput.value = '';
            ballsRemoved = 0; // Reset the new counter
            updateFeedback('Choose an operation to begin.', false);
            addBalls1Btn.textContent = 'Add Balls';
            addBalls2Btn.textContent = 'Add More Balls';
            addBalls2Btn.style.display = 'inline-block';
            takeAwayBallBtn.style.display = 'none';
            countAllBtn.style.display = 'none';
        });
    </script>
</body>
</html>
